---
import { supabase } from '../lib/supabase';
import { format } from 'date-fns';

interface UserProfile {
  full_name: string;
  role: string;
}

interface Message {
  id: number;
  content: string;
  created_at: string;
  user_id: string;
  user: UserProfile;
}

interface Props {
  source: string;
  instanceId?: string;
}

const { source, instanceId = 'default' } = Astro.props;

// Get latest messages with error handling and profile information
const { data: messages, error } = await supabase
  .from('forum_messages')
  .select(`
    id,
    content,
    created_at,
    user_id,
    source,
    user:profiles!forum_messages_user_id_fkey (
      full_name,
      role
    )
  `)
  .eq('source', source)
  .order('created_at', { ascending: true })
  .limit(20) as { data: Message[] | null; error: any };

if (error) {
  console.error('Error fetching messages:', error);
}
---

<div class="bg-gradient-to-br from-[#11315c]/95 to-[#11315c]/90 backdrop-blur-sm rounded-xl shadow-lg border border-[#11315c]/20 overflow-hidden" data-chat-source={source} data-instance-id={instanceId}>
  <!-- Header - Centered -->
  <div class="px-3 py-2.5 border-b border-[#11315c]/20 flex items-center justify-center backdrop-blur-sm bg-[#11315c]/30">
    <h2 class="text-xs font-medium flex items-center text-white">
      <svg class="w-3.5 h-3.5 mr-1.5 text-sky-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
      </svg>
      Commenti del articolo
    </h2>
  </div>

  <!-- Messages Container -->
  <div 
    class="h-[400px] overflow-y-auto overflow-x-hidden p-2 space-y-1.5" 
    id={`messages-container-${instanceId}`}
  >
    {messages?.map((message) => (
      <div class="group px-2 py-1.5 rounded-lg hover:bg-white/10 transition-all duration-200 border border-transparent hover:border-sky-300/20">
        <div class="flex items-start gap-1.5">
          <div class="w-5 h-5 rounded-lg bg-gradient-to-br from-sky-300/20 to-[#11315c]/20 flex items-center justify-center text-sky-300 font-medium text-[10px] flex-shrink-0 border border-sky-300/30">
            {message.user?.full_name?.charAt(0) || 'U'}
          </div>
          <div class="min-w-0">
            <div class="flex items-center gap-1.5 flex-wrap">
              <span class="text-xs font-medium text-white">
                {message.user?.full_name || 'User'}
              </span>
              <span class={`text-[9px] px-1.5 py-px rounded-full leading-none backdrop-blur-sm ${
                message.user?.role === 'docente' ? 'bg-sky-300/20 text-sky-300 border border-sky-300/30' :
                message.user?.role === 'studente' ? 'bg-[#11315c]/20 text-sky-300 border border-sky-300/30' :
                'bg-gray-100/20 text-white border border-white/30'
              }`}>
                {message.user?.role || 'user'}
              </span>
              <time class="text-[9px] text-sky-300/70">
                {format(new Date(message.created_at), 'HH:mm')}
              </time>
            </div>
            <p class="text-xs text-gray-200 break-words leading-relaxed mt-0.5">
              {message.content}
            </p>
          </div>
        </div>
      </div>
    ))}
  </div>

  <!-- Input Area -->
  <div class="p-2 border-t border-[#11315c]/20 bg-[#11315c]/50 backdrop-blur-sm">
    <div class="relative">
      <input
        type="text"
        id={`message-input-${instanceId}`}
        class="w-full rounded-lg text-xs border-sky-300/30 pr-10 pl-3 py-2 bg-white/10 backdrop-blur-sm placeholder:text-gray-300 text-white focus:border-sky-300 focus:ring focus:ring-sky-300/20 transition-all duration-200"
        placeholder="Type your message..."
      />
      <button
        id={`send-message-${instanceId}`}
        class="absolute right-1.5 top-1/2 -translate-y-1/2 p-1.5 text-sky-300 hover:text-white transition-all duration-200 rounded-md hover:bg-sky-300/20 disabled:opacity-50"
        title="Send message"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 send-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path class="send-icon-path" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.5 10.5L12 3m0 0l7.5 7.5M12 3v18" />
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
  import { supabase } from '../lib/supabase';

  console.log('ForumChat script initialized');
  

  const chatContainers = document.querySelectorAll('[data-chat-source]');

  chatContainers.forEach(container => {
    const instanceId = container.getAttribute('data-instance-id') || 'default';
    const messagesContainer = document.getElementById(`messages-container-${instanceId}`);
    const messageInput = document.getElementById(`message-input-${instanceId}`);
    const sendButton = document.getElementById(`send-message-${instanceId}`);
    const source = container.getAttribute('data-chat-source');

    console.log('ForumChat source:', source);

    console.log('Chat source:', source);

    console.log('Send button element:', sendButton);
    console.log('Message input element:', messageInput);


    // Function to create message HTML
    function createMessageElement(message) {
      const messageEl = document.createElement('div');
      messageEl.className = 'group px-2 py-1.5 rounded-lg hover:bg-white/10 transition-all duration-200 border border-transparent hover:border-sky-300/20';
      
      const roleClass = 
        message.user?.role === 'docente' ? 'bg-sky-300/20 text-sky-300 border border-sky-300/30' :
        message.user?.role === 'studente' ? 'bg-[#11315c]/20 text-sky-300 border border-sky-300/30' :
        'bg-gray-100/20 text-white border border-white/30';

      messageEl.innerHTML = `
        <div class="flex items-start gap-1.5">
          <div class="w-5 h-5 rounded-lg bg-gradient-to-br from-sky-300/20 to-[#11315c]/20 flex items-center justify-center text-sky-300 font-medium text-[10px] flex-shrink-0 border border-sky-300/30">
            ${message.user?.full_name?.charAt(0) || 'U'}
          </div>
          <div class="min-w-0">
            <div class="flex items-center gap-1.5 flex-wrap">
              <span class="text-xs font-medium text-white">
                ${message.user?.full_name || 'User'}
              </span>
              <span class="text-[9px] px-1.5 py-px rounded-full leading-none backdrop-blur-sm ${roleClass}">
                ${message.user?.role || 'user'}
              </span>
              <time class="text-[9px] text-sky-300/70">
                ${new Date(message.created_at).toLocaleTimeString([], { 
                  hour: '2-digit', 
                  minute: '2-digit' 
                })}
              </time>
            </div>
            <p class="text-xs text-gray-200 break-words leading-relaxed mt-0.5">
              ${message.content}
            </p>
          </div>
        </div>
      `;

      return messageEl;
    }

    // Function to scroll to bottom
    function scrollToBottom() {
      if (messagesContainer) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
    }

    // Send message function
    async function handleSendMessage() {
      console.log('Send message triggered');
      if (!messageInput || !messageInput.value.trim()) {
        return;
      }

      try {
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        console.log('Session check:', session?.user ? 'Logged in' : 'Not logged in');
        
        if (sessionError || !session?.user) {
          alert('Please log in to send messages');
          return;
        }

        const { error } = await supabase
          .from('forum_messages')
          .insert([
            {
              content: messageInput.value.trim(),
              user_id: session.user.id,
              source: source
            }
          ]);

        if (error) throw error;
        
        messageInput.value = '';
        scrollToBottom();
      } catch (error) {
        console.error('Error sending message:', error);
        alert('Error sending message');
      }
    }

    // Event listeners
    if (sendButton) {
      console.log('Send button found');
      sendButton.addEventListener('click', handleSendMessage);
    }

    if (messageInput) {
      console.log('Message input found');
      messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          handleSendMessage();
          console.log('Enter key pressed');
        }
      });
    }
    

    // Set up realtime subscription
    if (source) {
      console.log(`Setting up subscription for source: ${source}, instanceId: ${instanceId}`);
      const subscription = supabase
        .channel(`forum_messages_${instanceId}`)
        .on('postgres_changes', {
          event: 'INSERT',
          schema: 'public',
          table: 'forum_messages',
          filter: `source=eq.${source}`
        }, async (payload) => {
          console.log(`New message received in instance ${instanceId}:`, payload);
          try {
            // Fetch the complete message data including profile information
            const { data: message, error } = await supabase
              .from('forum_messages')
              .select(`
                id,
                content,
                created_at,
                user_id,
                source,
                user:profiles!forum_messages_user_id_fkey (
                  full_name,
                  role
                )
              `)
              .eq('id', payload.new.id)
              .single();

            if (error) throw error;
            if (!message || message.source !== source) return;

            // Get the specific container for this instance
            const targetContainer = document.getElementById(`messages-container-${instanceId}`);
            if (!targetContainer) {
              console.error(`Container not found for instance ${instanceId}`);
              return;
            }

            console.log(`Displaying new message in instance ${instanceId}:`, message);
            const messageEl = createMessageElement(message);
            targetContainer.appendChild(messageEl);
            
            // Scroll the specific container
            targetContainer.scrollTop = targetContainer.scrollHeight;
            
          } catch (error) {
            console.error(`Error handling new message in instance ${instanceId}:`, error);
          }
        })
        .subscribe();

      // Cleanup on page unload
      window.addEventListener('beforeunload', () => {
        console.log(`Unsubscribing from instance ${instanceId}`);
        subscription.unsubscribe();
      });
    }
  });
</script>

<style>
  .animate-fade-in {
    animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  #messages-container::-webkit-scrollbar {
    width: 3px;
  }

  #messages-container::-webkit-scrollbar-track {
    background: transparent;
  }

  #messages-container::-webkit-scrollbar-thumb {
    background: #e2e8f0;
    border-radius: 10px;
  }

  #messages-container::-webkit-scrollbar-thumb:hover {
    background: #cbd5e1;
  }

  #messages-container {
    scrollbar-width: thin;
    scrollbar-color: transparent transparent;
  }

  #messages-container:hover {
    scrollbar-color: #e2e8f0 transparent;
  }

  .send-icon-path {
    transform-origin: center;
    transition: transform 0.2s ease;
  }

  #send-message:hover .send-icon-path {
    transform: translateY(-1px);
  }

  #send-message:active .send-icon-path {
    transform: translateY(1px);
  }
</style>