---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../lib/supabase';
import { format } from 'date-fns';
import CategorySidebar from '../../components/CategorySidebar.astro';
import AudioPlayer from '../../components/AudioPlayer';
import { generateArticleStructuredData, generateBreadcrumbStructuredData } from '../../lib/seo';

const { category, slug } = Astro.params;
console.log(category, slug);
// Get article by slug and category
const { data: article } = await supabase
  .from('articles')
  .select('*')
  .eq('category_slug', category)
  .eq('slug', slug)
  .single();

console.log(article);

if (!article) {
  return Astro.redirect('/404');
}

// Format content into paragraphs
const formattedContent = article.content
  .split('\n\n')
  .map((paragraph: string) => paragraph.trim())
  .filter((paragraph: string) => paragraph.length > 0)
  .map((paragraph: string) => {
    // Check if paragraph is a header (starts with # or ##)
    if (paragraph.startsWith('# ')) {
      return `<h2 class="text-2xl font-bold text-gray-900 mt-8 mb-4">${paragraph.replace('# ', '')}</h2>`;
    }
    if (paragraph.startsWith('## ')) {
      return `<h3 class="text-xl font-bold text-gray-900 mt-6 mb-3">${paragraph.replace('## ', '')}</h3>`;
    }
    // Handle bold text
    paragraph = paragraph.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    // Handle italic text
    paragraph = paragraph.replace(/_(.*?)_/g, '<em>$1</em>');
    
    return `<p class="text-gray-700 leading-relaxed mb-4">${paragraph}</p>`;
  })
  .join('\n');

// Get related articles from the same category
const { data: relatedArticles } = await supabase
  .from('articles')
  .select('*')
  .eq('category', article.category)
  .neq('id', article.id)
  .order('published_at', { ascending: false })
  .limit(3);

// Generate structured data
const articleStructuredData = generateArticleStructuredData(article);
const breadcrumbStructuredData = generateBreadcrumbStructuredData(article);

// Get category color
const categoryColor = 'sport-500'; // Default color
---

<Layout title={`${article.title} - EduNews24`}>
  <head slot="head">
    <!-- Article metadata -->
    <meta name="author" content={article.creator || "EduNews24"} />
    <meta name="article:published_time" content={article.published_at} />
    <meta name="article:modified_time" content={article.updated_at || article.published_at} />
    <meta name="article:section" content={article.category} />
    <meta name="keywords" content={article.tags && article.tags.length > 0 ? article.tags.join(', ') : "intelligenza artificiale, scuola, studenti, educazione, tecnologia"} />
    <meta name="speakable_description" content={article.excerpt} />
    <meta name="description" content={article.excerpt} />
    
    <!-- Structured Data -->
    <script type="application/ld+json" set:html={articleStructuredData} />
    <script type="application/ld+json" set:html={breadcrumbStructuredData} />
  </head>
  
  <main class="bg-gray-50 min-h-screen py-8">
    <div class="container mx-auto px-4">
      <div class="flex flex-col lg:flex-row gap-8">
        <!-- Main Content -->
        <div class="flex-1 space-y-8">
          <!-- Breadcrumb Navigation -->
          <nav class="flex text-sm text-gray-600" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-1 md:space-x-3">
              <li class="inline-flex items-center">
                <a href="/" class="inline-flex items-center hover:text-sport-500">
                  <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
                  </svg>
                  Home
                </a>
              </li>
              <li>
                <div class="flex items-center">
                  <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                  </svg>
                  <a href={`/${article.category_slug}`} class="ml-1 hover:text-sport-500">{article.category}</a>
                </div>
              </li>
              <li aria-current="page">
                <div class="flex items-center">
                  <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                  </svg>
                  <span class="ml-1 text-gray-500 truncate max-w-xs">{article.title}</span>
                </div>
              </li>
            </ol>
          </nav>

          <article class="bg-white rounded-lg shadow-sm overflow-hidden">
            <img 
              src={article.image_url} 
              alt={article.title}
              class="w-full h-64 md:h-96 object-cover"
            />
            <div class="p-6 md:p-8">
              <!-- Article Header -->
              <div class="flex items-center gap-4 mb-6">
                <a 
                  href={`/category/${category}`}
                  class={`inline-block bg-${categoryColor} text-white px-3 py-1 text-sm font-semibold rounded-sm`}
                >
                  {article.category}
                </a>
                <time class="text-gray-500">
                  {format(new Date(article.published_at), 'dd MMM yyyy')} <span class="text-xs font-medium">GMT+1</span>
                </time>
                {article.creator && (
                  <div class="flex items-center text-gray-500">
                    <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span>{article.creator}</span>
                  </div>
                )}
              </div>

              <!-- Article Title and Excerpt -->
              <div class="mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-6 leading-tight">
                  {article.title}
                </h1>
                
                {article.audio_url && (
                  <div class="flex items-center gap-4 mb-6">
                    <button
                      id="show-audio-player"
                      class="inline-flex items-center gap-2 px-4 py-2 bg-sport-500 text-white rounded-full hover:bg-sport-600 transition-colors"
                    >
                      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z" clip-rule="evenodd"></path>
                      </svg>
                      Ascolta
                    </button>
                    <span class="text-sm text-gray-500">
                      Disponibile in formato audio
                    </span>
                  </div>
                  <div id="audio-player-container" class="hidden">
                    <AudioPlayer 
                      client:load 
                      audioUrl={article.audio_url}
                      title={article.title}
                    />
                  </div>
                )}

                <p class="text-xl text-gray-600 leading-relaxed mb-8 border-l-4 border-sport-500 pl-4 py-2 bg-gray-50 article-excerpt">
                  {article.excerpt}
                </p>
              </div>

              <!-- Article Content -->
              <div class="article-content" set:html={formattedContent} />
            </div>
          </article>

          <!-- Mobile Sidebar -->
          <div class="lg:hidden">
            <CategorySidebar source={`article:${article.id}`} 
            isMobile={true} 
            videoUrl={article.video_url || ''}
            articleTitle={article.title}/>
          </div>

          <!-- Related Articles -->
          {relatedArticles && relatedArticles.length > 0 && (
            <section class="bg-white rounded-lg shadow-sm p-6">
              <h2 class="text-xl font-bold mb-6">Articoli Correlati</h2>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                {relatedArticles.map(related => (
                  <article class={`bg-white rounded-lg overflow-hidden border-l-4 border-${categoryColor} hover:shadow-md transition-shadow`}>
                    <a href={`/articles/${related.id}`} class="block">
                      <img 
                        src={related.image_url} 
                        alt={related.title}
                        class="w-full h-48 object-cover"
                      />
                      <div class="p-4">
                        <time class="text-sm text-gray-500 mb-2 block">
                          {new Date(related.published_at).toLocaleDateString('en-GB')}
                        </time>
                        <h3 class="font-bold text-gray-900 line-clamp-2 hover:text-sport-500 transition-colors">
                          {related.title}
                        </h3>
                      </div>
                    </a>
                  </article>
                ))}
              </div>
            </section>
          )}
        </div>

        <!-- Desktop Sidebar -->
        <div class="hidden lg:block lg:w-80">
          <CategorySidebar source={`article:${article.id}`} articleTitle={article.Title} />
        </div>
      </div>
    </div>
  </main>
</Layout>

<style>
  .article-content :global(p) {
    margin-bottom: 1.5rem;
    line-height: 1.75;
  }
  
  .article-content :global(strong) {
    color: #1a1a1a;
    font-weight: 600;
  }
  
  .article-content :global(em) {
    font-style: italic;
    color: #4a5568;
  }

  .article-content :global(h2) {
    font-size: 1.875rem;
    font-weight: 700;
    margin-top: 2.5rem;
    margin-bottom: 1.25rem;
    color: #1a1a1a;
  }

  .article-content :global(h3) {
    font-size: 1.5rem;
    font-weight: 600;
    margin-top: 2rem;
    margin-bottom: 1rem;
    color: #2d3748;
  }
</style>

<script>
  const showAudioButton = document.getElementById('show-audio-player');
  const audioPlayerContainer = document.getElementById('audio-player-container');

  showAudioButton?.addEventListener('click', () => {
    audioPlayerContainer?.classList.toggle('hidden');
    if (showAudioButton.textContent?.includes('Ascolta')) {
      showAudioButton.innerHTML = `
        Nascondi
      `;
    } else {
      showAudioButton.innerHTML = `
        Ascolta
      `;
    }
  });
</script> 
