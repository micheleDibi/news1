---
import Layout from '../layouts/Layout.astro';
import { format, parseISO, isValid } from 'date-fns';
import type { BandoGara } from '../types/bandi-gare';
import fs from 'fs/promises';
import path from 'path';

// Define the path to the data file
const dataFilePath = path.resolve(process.cwd(), 'src/data/bandi-gare.json');

// Function to read bandi gare data
async function loadBandiGareData(): Promise<BandoGara[]> {
  try {
    const jsonData = await fs.readFile(dataFilePath, 'utf-8');
    const data = JSON.parse(jsonData);
    // Basic validation: check if it's an array
    if (Array.isArray(data)) {
       return data as BandoGara[];
    } else {
      // Log the invalid structure for debugging
      console.error('Error: bandi-gare.json does not contain a valid array. Found:', typeof data, JSON.stringify(data).substring(0, 100));
      return [];
    }
  } catch (error: any) {
    if (error.code === 'ENOENT') {
      console.warn('src/data/bandi-gare.json not found. Returning empty array.');
    } else {
      console.error('Error reading or parsing src/data/bandi-gare.json:', error);
    }
    return []; // Return empty array on error (e.g., file not found)
  }
}

// Load the data
const bandiGareData: BandoGara[] = await loadBandiGareData();

// Helper function to format date for data attributes (YYYY-MM-DD)
const formatDateForDataAttr = (dateString: string): string => {
   try {
    const parsedDate = parseISO(dateString);
    if (!isValid(parsedDate)) {
      return ""; // Return empty string for invalid dates
    }
    return format(parsedDate, 'yyyy-MM-dd'); // Format as YYYY-MM-DD
  } catch (e) {
    return ""; // Return empty string on error
  }
};

// Helper function to determine if a bando is expired
const isExpired = (scadenza?: string): boolean => {
  if (!scadenza) return false;
  try {
    const scadenzaDate = parseISO(scadenza);
    return isValid(scadenzaDate) && scadenzaDate < new Date();
  } catch (e) {
    return false;
  }
};

// Helper function to get status classes
const getStatusBorderColorClass = (bando: BandoGara): string => {
  if (isExpired(bando.scadenza)) return 'border-red-500';
  return 'border-green-500';
};

// Helper function to get status badge classes
const getStatusBadgeColor = (bando: BandoGara): string => {
  if (isExpired(bando.scadenza)) return 'bg-red-100 text-red-800';
  return 'bg-green-100 text-green-800';
};

// Get status text
const getStatusText = (bando: BandoGara): string => {
  if (isExpired(bando.scadenza)) return 'Scaduto';
  return 'Attivo';
};

// Unique values for filters
const uniqueOrigini = [...new Set(bandiGareData.map(b => b.origine).filter(Boolean))].sort();
const uniqueUffici = [...new Set(bandiGareData.map(b => b.ufficio).filter(Boolean))].sort();

const pageTitle = "Bandi di Gara e Contratti - EduNews24";
const pageDescription = "Esplora i bandi di gara e contratti del Ministero dell'Interno e delle pubbliche amministrazioni italiane";
const pageKeywords = "bandi di gara, contratti pubblici, appalti, gare pubbliche, ministero interno, pubblica amministrazione, CIG, ANAC";
---
<Layout title={pageTitle} description={pageDescription} keywords={pageKeywords}>
  <main class="bg-gray-50 py-12">
    <div class="container mx-auto px-4 max-w-6xl">
      <div class="mb-10 border-b pb-4">
        <h1 class="text-3xl md:text-4xl font-bold text-primary">Bandi di Gara e Contratti</h1>
        <p class="text-gray-600 mt-2">Ministero dell'Interno - Amministrazione Trasparente</p>
      </div>

      {/* Filter Controls */}
      <div class="mb-8 p-4 bg-white rounded-md shadow-sm">
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 items-end">
          {/* Search */}
          <div class="lg:col-span-1">
            <label for="search-filter" class="block text-sm font-medium text-gray-700 mb-1">Cerca</label>
            <input type="text" id="search-filter" placeholder="Titolo, CIG, Ufficio..." class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary text-sm">
          </div>
          {/* Status */}
          <div class="lg:col-span-1">
            <label for="status-filter" class="block text-sm font-medium text-gray-700 mb-1">Stato</label>
            <select id="status-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary text-sm bg-white">
              <option value="">Tutti</option>
              <option value="attivo">Attivo</option>
              <option value="scaduto">Scaduto</option>
            </select>
          </div>
          {/* Data Atto */}
          <div class="lg:col-span-1">
             <label for="data-atto-filter" class="block text-sm font-medium text-gray-700 mb-1">Data Atto Da</label>
             <input type="date" id="data-atto-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary text-sm">
          </div>
          {/* Scadenza */}
          <div class="lg:col-span-1">
             <label for="scadenza-filter" class="block text-sm font-medium text-gray-700 mb-1">Scadenza Entro</label>
             <input type="date" id="scadenza-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary text-sm">
          </div>
          {/* Origine */}
          <div class="lg:col-span-1">
            <label for="origine-filter" class="block text-sm font-medium text-gray-700 mb-1">Origine</label>
            <select id="origine-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary text-sm bg-white">
              <option value="">Tutte</option>
              {uniqueOrigini.map(origine => <option value={origine}>{origine}</option>)}
            </select>
          </div>
          {/* Ufficio */}
          <div class="lg:col-span-1">
            <label for="ufficio-filter" class="block text-sm font-medium text-gray-700 mb-1">Ufficio</label>
            <select id="ufficio-filter" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary text-sm bg-white">
              <option value="">Tutti</option>
              {uniqueUffici.map(ufficio => <option value={ufficio}>{ufficio}</option>)}
            </select>
          </div>
          {/* Reset Button */}
           <div class="lg:col-span-2 flex items-end">
             <button id="reset-filters" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
               Resetta Filtri
             </button>
           </div>
        </div>
      </div>
      {/* End Filter Controls */}

      {/* Refresh Button */}
      <div class="mb-6">
        <button id="refresh-data" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 text-sm font-medium">
          Aggiorna Dati
        </button>
        <span id="refresh-status" class="ml-3 text-sm text-gray-600"></span>
      </div>

      <div id="bandi-list" class="space-y-5">
        {bandiGareData.length === 0 ? (
          <p id="no-results-message" class="text-center text-gray-500 text-lg py-10">Nessun bando trovato al momento.</p>
        ) : (
          <>
            {bandiGareData.map((bando: BandoGara) => (
              <article
                class:list={["bando-item bg-white rounded-md border overflow-hidden transition-colors duration-200 hover:border-gray-300", getStatusBorderColorClass(bando)]}
                data-title={bando.titolo?.toLowerCase()}
                data-origine={bando.origine?.toLowerCase()}
                data-ufficio={bando.ufficio?.toLowerCase()}
                data-cig={bando.cig?.toLowerCase()}
                data-status={isExpired(bando.scadenza) ? 'scaduto' : 'attivo'}
                data-data-atto={formatDateForDataAttr(bando.data_atto || '')}
                data-scadenza={formatDateForDataAttr(bando.scadenza || '')}
              >
                <div class="p-5">
                  <div class="flex flex-col sm:flex-row justify-between sm:items-start gap-3 mb-4">
                    <div class="flex-1">
                      <h2 class="text-lg font-semibold text-gray-800 mb-2">{bando.titolo}</h2>
                      {(bando.origine || bando.ufficio) && (
                         <p class="text-sm text-gray-500 mb-2">
                          {bando.origine && (
                                <>
                                  <span class="font-medium text-gray-600">Origine:</span> {bando.origine}
                                  {bando.ufficio && <span class="mx-1">|</span>}
                                </>
                          )}
                           {bando.ufficio && (
                                <>
                                  <span class="font-medium text-gray-600">Ufficio:</span> {bando.ufficio}
                                </>
                               )}
                        </p>
                       )}
                    </div>
                    <div class="flex-shrink-0 text-right space-y-1 pt-1">
                      <span class={`inline-block px-2.5 py-0.5 text-xs font-medium rounded-full ${getStatusBadgeColor(bando)}`}>
                        {getStatusText(bando)}
                      </span>
                       {bando.cig && <p class="text-xs text-gray-400">CIG: {bando.cig}</p>}
                    </div>
                  </div>

                  <div class="grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-3 mb-4 text-sm border-t border-gray-100 pt-4 mt-4">
                    {bando.data_atto_human && (
                      <div>
                        <p class="text-xs text-gray-500 uppercase tracking-wider">Data Atto</p>
                        <p class="font-medium text-gray-700 text-xs">{bando.data_atto_human}</p>
                      </div>
                    )}
                    {bando.scadenza_human && (
                      <div>
                        <p class="text-xs text-gray-500 uppercase tracking-wider">Scadenza</p>
                        <p class={`font-medium text-xs ${isExpired(bando.scadenza) ? 'text-red-600' : 'text-green-600'}`}>{bando.scadenza_human}</p>
                      </div>
                    )}
                    {bando.cig && (
                      <div>
                        <p class="text-xs text-gray-500 uppercase tracking-wider">Codice CIG</p>
                        <p class="font-medium text-gray-700 text-xs">{bando.cig}</p>
                      </div>
                    )}
                  </div>
                </div>

                <div class="p-5 pt-0 flex flex-col sm:flex-row sm:justify-end items-start sm:items-center gap-3 border-t border-gray-100 mt-auto">
                  <div class="flex gap-2">
                    {bando.url && (
                      <a
                        href={bando.url}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="inline-flex items-center px-3.5 py-1.5 border border-primary text-sm font-medium rounded text-primary bg-white hover:bg-primary/5 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-primary transition"
                      >
                        Vai al Bando
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 ml-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                        </svg>
                      </a>
                    )}
                    {bando.link_anac && (
                      <a
                        href={bando.link_anac}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="inline-flex items-center px-3.5 py-1.5 border border-gray-300 text-sm font-medium rounded text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-gray-500 transition"
                      >
                        ANAC
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 ml-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                        </svg>
                      </a>
                    )}
                  </div>
                </div>
              </article>
            ))}
             {/* Message shown when no results match filters */}
             <p id="no-results-message" class="text-center text-gray-500 text-lg py-10 hidden">Nessun bando corrisponde ai filtri selezionati.</p>
          </>
        )}
      </div>
    </div>
  </main>
</Layout>

<script is:inline>
  const searchInput = document.getElementById('search-filter');
  const statusSelect = document.getElementById('status-filter');
  const dataAttoInput = document.getElementById('data-atto-filter');
  const scadenzaInput = document.getElementById('scadenza-filter');
  const origineSelect = document.getElementById('origine-filter');
  const ufficioSelect = document.getElementById('ufficio-filter');
  const bandiList = document.getElementById('bandi-list');
  const bandoItems = bandiList ? Array.from(bandiList.querySelectorAll('.bando-item')) : [];
  const noResultsMessage = document.getElementById('no-results-message');
  const resetButton = document.getElementById('reset-filters');
  const refreshButton = document.getElementById('refresh-data');
  const refreshStatus = document.getElementById('refresh-status');

  function filterBandi() {
    const searchTerm = searchInput.value.toLowerCase().trim();
    const selectedStatus = statusSelect.value;
    const selectedDataAtto = dataAttoInput.value;
    const selectedScadenza = scadenzaInput.value;
    const selectedOrigine = origineSelect.value;
    const selectedUfficio = ufficioSelect.value;
    let visibleCount = 0;

    bandoItems.forEach(item => {
      const title = item.dataset.title || '';
      const origine = item.dataset.origine || '';
      const ufficio = item.dataset.ufficio || '';
      const cig = item.dataset.cig || '';
      const status = item.dataset.status || '';
      const dataAtto = item.dataset.dataAtto || '';
      const scadenza = item.dataset.scadenza || '';

      // Filtering Logic
      const textMatch = searchTerm === '' || title.includes(searchTerm) || origine.includes(searchTerm) || ufficio.includes(searchTerm) || cig.includes(searchTerm);
      const statusMatch = selectedStatus === '' || status === selectedStatus;
      const dataAttoMatch = !selectedDataAtto || dataAtto >= selectedDataAtto;
      const scadenzaMatch = !selectedScadenza || scadenza <= selectedScadenza;
      const origineMatch = selectedOrigine === '' || origine === selectedOrigine.toLowerCase();
      const ufficioMatch = selectedUfficio === '' || ufficio === selectedUfficio.toLowerCase();

      // Combine all matches
      if (textMatch && statusMatch && dataAttoMatch && scadenzaMatch && origineMatch && ufficioMatch) {
        item.style.display = '';
        visibleCount++;
      } else {
        item.style.display = 'none';
      }
    });

    // Update no results message
    if (noResultsMessage) {
       noResultsMessage.style.display = visibleCount === 0 ? 'block' : 'none';
    }
  }

  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  const debouncedFilter = debounce(filterBandi, 250);

  if (searchInput) searchInput.addEventListener('input', debouncedFilter);
  if (statusSelect) statusSelect.addEventListener('change', filterBandi);
  if (dataAttoInput) dataAttoInput.addEventListener('change', filterBandi);
  if (scadenzaInput) scadenzaInput.addEventListener('change', filterBandi);
  if (origineSelect) origineSelect.addEventListener('change', filterBandi);
  if (ufficioSelect) ufficioSelect.addEventListener('change', filterBandi);

   if (resetButton) {
    resetButton.addEventListener('click', () => {
      searchInput.value = '';
      statusSelect.value = '';
      dataAttoInput.value = '';
      scadenzaInput.value = '';
      origineSelect.value = '';
      ufficioSelect.value = '';
      filterBandi();
    });
  }

  // Refresh data functionality
  if (refreshButton) {
    refreshButton.addEventListener('click', async () => {
      refreshStatus.textContent = 'Aggiornamento in corso...';
      refreshButton.disabled = true;
      
      try {
        const response = await fetch('/api/bandi-gare/refresh');
        const result = await response.json();
        
        if (response.ok) {
          refreshStatus.textContent = 'Dati aggiornati! Ricarica la pagina per vedere i nuovi risultati.';
          refreshStatus.className = 'ml-3 text-sm text-green-600';
        } else {
          refreshStatus.textContent = 'Errore durante l\'aggiornamento: ' + result.message;
          refreshStatus.className = 'ml-3 text-sm text-red-600';
        }
      } catch (error) {
        refreshStatus.textContent = 'Errore di connessione durante l\'aggiornamento.';
        refreshStatus.className = 'ml-3 text-sm text-red-600';
      } finally {
        refreshButton.disabled = false;
        setTimeout(() => {
          refreshStatus.textContent = '';
          refreshStatus.className = 'ml-3 text-sm text-gray-600';
        }, 5000);
      }
    });
  }
</script> 