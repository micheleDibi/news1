---
export const prerender = false;

import AdminLayout from '../../../layouts/AdminLayout.astro';
import { supabase } from '../../../lib/supabase';

// Set cache control headers
Astro.response.headers.set('Cache-Control', 'no-store, no-cache, must-revalidate, proxy-revalidate');
Astro.response.headers.set('Pragma', 'no-cache');
Astro.response.headers.set('Expires', '0');
Astro.response.headers.set('Surrogate-Control', 'no-store');

const { id } = Astro.params;

// Get the user profile by id
const { data: profile, error: fetchError } = await supabase
  .from('profiles')
  .select('id, full_name, email, description, is_displayable, profile_pic_link')
  .eq('id', id)
  .single();

if (fetchError) {
  console.error("Error fetching profile:", fetchError);
}
---

<AdminLayout title="Modifica Profilo Utente">
  <!-- Loading screen -->
  <div id="loading-screen" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-sport-500 mb-4"></div>
      <p class="text-sport-600">Loading...</p>
    </div>
  </div>

  <div id="admin-content" class="hidden">
    <div class="py-6">
      <div class="max-w-2xl mx-auto px-4 sm:px-6 md:px-8">
        <!-- Header -->
        <div class="mb-6">
          <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
            Modifica Profilo Utente
          </h2>
        </div>

        <!-- Profile Edit Form -->
        <div class="bg-white shadow overflow-hidden sm:rounded-lg">
          <form id="profile-form">
            <div class="px-6 py-4">
              <input type="hidden" id="profile-id-input" name="id" value={profile?.id}>
              <div class="mb-4">
                <label for="profile-description" class="block text-sm font-medium text-gray-700">Descrizione</label>
                <textarea name="description" id="profile-description" rows="4" class="mt-1 focus:ring-primary focus:border-primary block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="Descrizione del profilo pubblico...">{profile?.description || ''}</textarea>
                <p class="mt-1 text-xs text-gray-500">Descrizione pubblica del profilo utente.</p>
              </div>
              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-3">Foto Profilo</label>
                <div class="mb-4">
                  <label for="profile-pic-file" class="block text-sm font-medium text-gray-600 mb-2">Carica File</label>
                  <div class="flex items-center gap-3">
                    <input 
                      type="file" 
                      id="profile-pic-file" 
                      accept="image/*"
                      class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-primary-dark"
                    >
                    <button type="button" id="upload-file-button" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:opacity-50" disabled>
                      <span class="upload-text">Carica</span>
                      <span class="upload-loading hidden">Caricamento...</span>
                    </button>
                  </div>
                </div>
                <div class="mb-4">
                  <label for="profile-pic-link" class="block text-sm font-medium text-gray-600 mb-2">Oppure inserisci URL</label>
                  <div class="flex items-center gap-3">
                    <input type="url" name="profile_pic_link" id="profile-pic-link" value={profile?.profile_pic_link || ''} class="flex-1 focus:ring-primary focus:border-primary block w-full shadow-sm sm:text-sm border-gray-300 rounded-md" placeholder="https://esempio.com/foto.jpg">
                    <button type="button" id="upload-url-button" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50">
                      <span class="url-upload-text">Usa URL</span>
                      <span class="url-upload-loading hidden">Caricamento...</span>
                    </button>
                  </div>
                </div>
                <p class="text-xs text-gray-500 mb-3">Carica un file immagine o inserisci l'URL di un'immagine esistente.</p>
                <div id="profile-pic-preview" class={profile?.profile_pic_link ? '' : 'hidden'}>
                  <label class="block text-sm font-medium text-gray-700">Anteprima Foto</label>
                  <img id="profile-pic-preview-img" src={profile?.profile_pic_link || ''} alt="Anteprima" class="mt-1 h-16 w-16 rounded-full object-cover border border-gray-300">
                </div>
              </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 flex justify-end space-x-3">
              <button type="submit" id="save-profile-button" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                Salva Profilo
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

</AdminLayout>

<script>
  import { supabase } from '../../../lib/supabase';

  const profileForm = document.getElementById('profile-form') as HTMLFormElement | null;
  // const profileDescriptionInput = document.getElementById('profile-description');
  // const profileDisplayableSelect = document.getElementById('profile-displayable');
  const profilePicLinkInput = document.getElementById('profile-pic-link');
  const profilePicFileInput = document.getElementById('profile-pic-file');
  const uploadFileButton = document.getElementById('upload-file-button');
  const uploadUrlButton = document.getElementById('upload-url-button');
  const profilePicPreview = document.getElementById('profile-pic-preview');
  const profilePicPreviewImg = document.getElementById('profile-pic-preview-img');
  const saveButton = document.getElementById('save-profile-button') as HTMLButtonElement | null;
  const loadingScreen = document.getElementById('loading-screen');
  const adminContent = document.getElementById('admin-content');

  // Auth Check (show content after load)
  async function checkAuth() {
    loadingScreen?.classList.remove('hidden');
    adminContent?.classList.add('hidden');
    const { data: { session }, error: sessionError } = await supabase.auth.getSession();
    if (sessionError || !session) {
      window.location.href = '/login';
      return;
    }
    loadingScreen?.classList.add('hidden');
    adminContent?.classList.remove('hidden');
  }
  checkAuth();

  function showProfilePicPreview(url: string) {
    if (profilePicPreviewImg) (profilePicPreviewImg as HTMLImageElement).src = url;
    profilePicPreview?.classList.remove('hidden');
  }
  function hideProfilePicPreview() {
    profilePicPreview?.classList.add('hidden');
    if (profilePicPreviewImg) (profilePicPreviewImg as HTMLImageElement).src = '';
  }
  profilePicLinkInput?.addEventListener('input', () => {
    if (!profilePicLinkInput) return;
    const url = (profilePicLinkInput as HTMLInputElement).value.trim();
    if (url && isValidUrl(url)) {
      showProfilePicPreview(url);
    } else {
      hideProfilePicPreview();
    }
  });
  profilePicFileInput?.addEventListener('change', () => {
    const file = (profilePicFileInput as HTMLInputElement).files?.[0];
    if (uploadFileButton instanceof HTMLButtonElement) uploadFileButton.disabled = !file;
  });
  uploadFileButton?.addEventListener('click', async () => {
    const file = (profilePicFileInput as HTMLInputElement).files?.[0];
    if (!file) return;
    const uploadText = uploadFileButton.querySelector('.upload-text');
    const uploadLoading = uploadFileButton.querySelector('.upload-loading');
    if (uploadText) uploadText.classList.add('hidden');
    if (uploadLoading) uploadLoading.classList.remove('hidden');
    if (uploadFileButton instanceof HTMLButtonElement) uploadFileButton.disabled = true;
    try {
      const tempUrl = URL.createObjectURL(file);
      showProfilePicPreview(tempUrl);
      const formData = new FormData();
      formData.append('file', file);
      formData.append('filename', `profile_${generateUUID()}.${file.name.split('.').pop()}`);
      formData.append('title', 'profile');
      const uploadResponse = await fetch('/api/upload', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${import.meta.env.PUBLIC_API_SECRET_KEY}` },
        body: formData
      });
      if (!uploadResponse.ok) throw new Error('Failed to upload image file');
      const { url } = await uploadResponse.json();
      URL.revokeObjectURL(tempUrl);
      if (profilePicLinkInput) (profilePicLinkInput as HTMLInputElement).value = url;
      showProfilePicPreview(url);
    } catch (error) {
      const errMsg = error instanceof Error ? error.message : String(error);
      alert('Errore nel caricamento dell\'immagine: ' + errMsg);
      hideProfilePicPreview();
    } finally {
      if (uploadText) uploadText.classList.remove('hidden');
      if (uploadLoading) uploadLoading.classList.add('hidden');
      if (uploadFileButton instanceof HTMLButtonElement) uploadFileButton.disabled = false;
    }
  });
  uploadUrlButton?.addEventListener('click', async () => {
    if (!profilePicLinkInput) return;
    const imageUrl = (profilePicLinkInput as HTMLInputElement).value.trim();
    if (!imageUrl || !isValidUrl(imageUrl)) {
      alert('Inserisci un URL valido.');
      return;
    }
    const urlUploadText = uploadUrlButton.querySelector('.url-upload-text');
    const urlUploadLoading = uploadUrlButton.querySelector('.url-upload-loading');
    if (urlUploadText) urlUploadText.classList.add('hidden');
    if (urlUploadLoading) urlUploadLoading.classList.remove('hidden');
    if (uploadUrlButton instanceof HTMLButtonElement) uploadUrlButton.disabled = true;
    try {
      const response = await fetch('/api/upload-from-url', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${import.meta.env.PUBLIC_API_SECRET_KEY}` },
        body: JSON.stringify({ url: imageUrl, filename: `profile_${generateUUID()}.webp` })
      });
      if (!response.ok) throw new Error('Failed to upload image from URL');
      const { url } = await response.json();
      if (profilePicLinkInput) (profilePicLinkInput as HTMLInputElement).value = url;
      showProfilePicPreview(url);
    } catch (error) {
      const errMsg = error instanceof Error ? error.message : String(error);
      alert('Errore nel caricamento dell\'immagine da URL: ' + errMsg);
    } finally {
      if (urlUploadText) urlUploadText.classList.remove('hidden');
      if (urlUploadLoading) urlUploadLoading.classList.add('hidden');
      if (uploadUrlButton instanceof HTMLButtonElement) uploadUrlButton.disabled = false;
    }
  });
  function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      const r = Math.random() * 16 | 0;
      const v = c == 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }
  function isValidUrl(string: string) {
    try { new URL(string); return true; } catch (_) { return false; }
  }
  profileForm?.addEventListener('submit', async (event) => {
    event.preventDefault();
    const formData = new FormData(profileForm);
    const profileId = formData.get('id');
    const description = formData.get('description') || '';
    const isDisplayable = formData.get('is_displayable') === 'true';
    const profilePicLink = formData.get('profile_pic_link') || '';
    if (!profileId) {
      alert('Errore: ID profilo mancante.');
      return;
    }
    const profilePayload = {
      description,
      is_displayable: isDisplayable,
      profile_pic_link: profilePicLink || null,
    };
    if (saveButton) {
      saveButton.disabled = true;
      saveButton.textContent = 'Salvataggio...';
    }
    try {
      const { data, error } = await supabase
        .from('profiles')
        .update(profilePayload)
        .eq('id', profileId)
        .select('id, full_name, email, description, is_displayable, profile_pic_link')
        .single();
      if (error) {
        alert(`Errore durante il salvataggio del profilo: ${error.message}`);
      } else if (data) {
        alert('Profilo aggiornato con successo!');
        window.location.reload();
      }
    } catch (err) {
      alert('Si Ã¨ verificato un errore inaspettato.');
    } finally {
      if (saveButton) {
        saveButton.disabled = false;
        saveButton.textContent = 'Salva Profilo';
      }
    }
  });
</script> 