---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import { supabase } from '../lib/supabase';
import { format, subHours } from 'date-fns';
import { getCategoryBySlug, categories as allCategories } from '../lib/categories';
import CategorySidebar from '../components/CategorySidebar.astro';
import { generateItemListStructuredData, generateBreadcrumbStructuredData } from '../lib/seo';
import type { Category, SecondaryCategory, Article } from '../lib/supabase';

// page size + helpers ---------------------------------
const PER_PAGE = 21;
const pageParam = Number(Astro.url.searchParams.get('page') || '1');
const page = pageParam < 1 ? 1 : Math.floor(pageParam);          // force positive int
const from = (page - 1) * PER_PAGE;
const to   = from + PER_PAGE - 1;

const { category: categorySlug } = Astro.params;
const currentSecondaryFilter = Astro.url.searchParams.get('secondary_filter');
const currentOriginalCategoryFilter = Astro.url.searchParams.get('original_category_filter');

// Define placeholder for category and articles data
let category: Category | undefined | null;
let articles: Article[] = []; // Use Article type
let totalCount: number | null = 0;
let articlesError: any = null;
let availableSecondaryCategories: SecondaryCategory[] = [];
let uniqueOriginalCategoriesForFilter: { name: string, slug: string }[] = [];

const ultimOraSlug = "ultim-ora";

if (categorySlug === ultimOraSlug) {
  // Handle Ultim'Ora as a special dynamic category
  category = {
    id: 'ultim-ora-virtual-id',
    name: "Ultim'Ora",
    slug: ultimOraSlug,
    color: "red-500", // Consistent with index page
    keywords: 'ultim ora, breaking news, notizie urgenti',
    description: 'Le notizie dell\'ultim\'ora dal mondo della scuola e dell\'educazione.',
    // Add other necessary Category fields if your template expects them
    // order_id might not be relevant here or set to a high/low number if sorting
  };

  const fortyEightHoursAgo = subHours(new Date(), 48).toISOString();
  let ultimOraQuery = supabase
    .from('articles')
    .select('*', { count: 'exact' })
    .eq('isdraft', false)
    .gte('published_at', fortyEightHoursAgo);

  // Apply original category filter if present for Ultim'Ora page
  if (currentOriginalCategoryFilter) {
    ultimOraQuery = ultimOraQuery.eq('category_slug', currentOriginalCategoryFilter);
  }
  
  // Add ordering and range after potential filtering
  ultimOraQuery = ultimOraQuery
    .order('published_at', { ascending: false })
    .range(from, to);

  const { data: ultimOraArticlesData, error: ultimOraError, count: ultimOraTotalCount } = await ultimOraQuery;
  articles = ultimOraArticlesData || [];
  totalCount = ultimOraTotalCount;
  articlesError = ultimOraError;
  
  // Secondary categories are not applicable for Ultim'Ora
  // availableSecondaryCategories is already initialized as []

  // Populate unique original categories for the filter UI (only if no filter is active yet, to show all options)
  if (!currentOriginalCategoryFilter && articles.length > 0) {
    const tempCategories = new Map<string, { name: string, slug: string }>();
    // Need to fetch ALL articles in last 48h to correctly populate this, not just the paginated ones.
    const { data: allUltimOraArticlesForFilter } = await supabase
        .from('articles')
        .select('category, category_slug')
        .eq('isdraft', false)
        .gte('published_at', fortyEightHoursAgo);

    if (allUltimOraArticlesForFilter) {
        allUltimOraArticlesForFilter.forEach(article => {
            if (article.category_slug && article.category) {
                tempCategories.set(article.category_slug, { name: article.category, slug: article.category_slug });
            }
        });
        uniqueOriginalCategoriesForFilter = Array.from(tempCategories.values())
            .sort((a, b) => a.name.localeCompare(b.name)); // Sort alphabetically
    }
  } else if (currentOriginalCategoryFilter) {
      // If a filter is active, we still need to populate the list for UI consistency.
      // This logic might need refinement if we want to show *all* possible original cats even when one is selected.
      // For now, let's re-fetch all possible categories if a filter is active to ensure the dropdown is always populated.
      // This is a simplified approach; a more optimized one might store this list or fetch it once.
      const { data: allUltimOraArticlesForFilter } = await supabase
        .from('articles')
        .select('category, category_slug')
        .eq('isdraft', false)
        .gte('published_at', fortyEightHoursAgo);
       if (allUltimOraArticlesForFilter) {
        const tempCategories = new Map<string, { name: string, slug: string }>();
        allUltimOraArticlesForFilter.forEach(article => {
            if (article.category_slug && article.category) {
                tempCategories.set(article.category_slug, { name: article.category, slug: article.category_slug });
            }
        });
        uniqueOriginalCategoriesForFilter = Array.from(tempCategories.values())
            .sort((a, b) => a.name.localeCompare(b.name));
       }
  }

} else {
  // Existing logic for regular categories
  category = getCategoryBySlug(categorySlug || '');

  if (!category) {
    return Astro.redirect('/404');
  }

  // Fetch available secondary categories for this primary category
  const { data: secCatsForFilter, error: secCatsForFilterError } = await supabase
    .from('secondary_categories')
    .select('id, name, slug, parent_category_slug')
    .eq('parent_category_slug', categorySlug);

  if (secCatsForFilterError) {
    console.error('Error fetching secondary categories for filter:', secCatsForFilterError);
  } else {
    availableSecondaryCategories = secCatsForFilter || [];
  }

  // Base query for articles
  let articlesQueryBase = supabase
    .from('articles')
    .select('*', { count: 'exact' })        // ðŸ‘ˆ ask for a row count
    .eq('category_slug', categorySlug)
    .eq('isdraft', false);

  // Apply secondary category filter if present
  if (currentSecondaryFilter) {
    articlesQueryBase = articlesQueryBase.contains('secondary_category_slugs', [currentSecondaryFilter]);
  }

  const articlesQueryFinal = articlesQueryBase
    .order('published_at', { ascending: false })
    .range(from, to);                       // ðŸ‘ˆ slice for the current page

  const { data: regularArticlesData, error: regularArticlesError, count: regularTotalCount } = await articlesQueryFinal;
  articles = regularArticlesData || [];
  totalCount = regularTotalCount;
  articlesError = regularArticlesError;
}

if (articlesError) {
    console.error(`Error fetching articles for ${categorySlug}:`, articlesError);
    // Potentially show an error message to the user or redirect
    // For now, we let it proceed to see if !category check handles it or if page shows 0 articles
}

// Moved this check down, after category might be manually defined for ultim'ora
if (!category) { // This should ideally not be hit if ultim'ora is handled, but as a safeguard
  console.warn(`Category object is null/undefined for slug: ${categorySlug} after processing. Redirecting to 404.`);
  return Astro.redirect('/404');
}

const totalPages = Math.max(1, Math.ceil((totalCount ?? 0) / PER_PAGE));
if (page > totalPages && totalPages > 1) { // if totalPages is 1, page 1 is fine.
  return Astro.redirect(`/${category.slug}${currentSecondaryFilter ? `?secondary_filter=${currentSecondaryFilter}` : ''}`); // out-of-range? go home for this filter
}

const DOTS = '...';
const range = (start: number, end: number) => {
  let length = end - start + 1;
  return Array.from({ length }, (_, idx) => idx + start);
};

const getPaginationItems = (currentPage: number, totalPages: number, siblingCount = 1): (string | number)[] => {
  const totalPageNumbers = siblingCount + 5; // Min items: 1 ... S S S ... L (siblingCount + first + last + current + 2*DOTS)

  if (totalPageNumbers >= totalPages) {
    return range(1, totalPages);
  }

  const leftSiblingIndex = Math.max(currentPage - siblingCount, 1);
  const rightSiblingIndex = Math.min(currentPage + siblingCount, totalPages);

  const shouldShowLeftDots = leftSiblingIndex > 2;
  const shouldShowRightDots = rightSiblingIndex < totalPages - 2;

  const firstPageIndex = 1;
  const lastPageIndex = totalPages;

  if (!shouldShowLeftDots && shouldShowRightDots) {
    let leftItemCount = 3 + 2 * siblingCount;
    let leftRangeArr = range(1, leftItemCount);
    return [...leftRangeArr, DOTS, totalPages];
  }

  if (shouldShowLeftDots && !shouldShowRightDots) {
    let rightItemCount = 3 + 2 * siblingCount;
    let rightRangeArr = range(totalPages - rightItemCount + 1, totalPages);
    return [firstPageIndex, DOTS, ...rightRangeArr];
  }

  if (shouldShowLeftDots && shouldShowRightDots) {
    let middleRangeArr = range(leftSiblingIndex, rightSiblingIndex);
    return [firstPageIndex, DOTS, ...middleRangeArr, DOTS, lastPageIndex];
  }
  
  // Fallback, though ideally covered by the first condition
  return range(1, totalPages);
};

const pageItems = totalPages > 1 ? getPaginationItems(page, totalPages, 1) : [1];

// Transform articles to match the card design
const transformedArticles = articles.map(article => {
  let baseColor = 'gray-500'; // Default base color

  if (categorySlug === ultimOraSlug) {
    const originalCategory = allCategories.find(c => c.slug === article.category_slug);
    if (originalCategory?.color) {
      baseColor = originalCategory.color;
    }
  } else if (category.color) {
    baseColor = category.color;
  }

  return {
    title: article.title,
    image: article.image_url,
    category: article.category, 
    date: format(new Date(article.published_at), 'dd/MM/yyyy'),
    excerpt: article.excerpt,
    href: `/${article.category_slug}/${article.slug}`,
    borderColor: `border-${baseColor}`,
    bgColor: `bg-${baseColor}`,
    textColor: `text-${baseColor}`,
  };
});

// Split articles into featured and regular
const featuredArticle = transformedArticles[0];
const secondaryArticles = transformedArticles.slice(1, 3);
const regularArticles = transformedArticles.slice(3);

// --- Define Meta Keywords --- //
let categoryKeywords: string[] = [];
if (category.keywords) {
  if (typeof category.keywords === 'string') {
    try {
      const parsed = JSON.parse(category.keywords);
      if (Array.isArray(parsed)) {
        categoryKeywords = parsed.map(String);
      }
    } catch (e) {
      console.warn('Could not parse category keywords JSON:', category.keywords);
    }
  } else if (Array.isArray(category.keywords)) {
    categoryKeywords = category.keywords.map(String);
  }
}

// Combine fetched keywords with defaults
const combinedKeywords = [
  category.name, 
  'edunews24', 
  `notizie ${category.name}`,
  ...categoryKeywords // Add fetched keywords
];

// Remove duplicates and join
const uniqueKeywords = [...new Set(combinedKeywords.filter(k => k))]; // Filter out empty/null
const metaKeywords = uniqueKeywords.join(', ');
// --- End Meta Keywords --- //

// Define the meta description
const metaDescription = (category.description 
  ? `${category.description} - EduNews24 - Il portale online gratuito con tante notizie provenienti dal ${category.name}`
  : `EduNews24 - Il portale online gratuito con tante notizie provenienti dal ${category.name}`);

// --- Generate Structured Data ---
const pageUrl = categorySlug === ultimOraSlug ? `https://edunews24.it/ultim-ora` : `https://edunews24.it/${category.slug}`;

const canonicalUrl =
  page === 1
    ? pageUrl                                   // first page keeps the clean URL
    : `${pageUrl}?page=${page}${currentSecondaryFilter ? `&secondary_filter=${currentSecondaryFilter}` : ''}`;

// Generate ItemList for the articles displayed
const itemListStructuredData = generateItemListStructuredData(
  transformedArticles,
  `Articoli nella categoria ${category.name}`,
  pageUrl
);

// Generate Breadcrumbs
// Pass a simple object with category info, as the function expects an 'article-like' structure
const breadcrumbData = {
  category: category.name,
  category_slug: category.slug
  // No 'slug' or 'title' - this will make generateBreadcrumbStructuredData stop after the category
};
const breadcrumbStructuredData = generateBreadcrumbStructuredData(breadcrumbData);
// --- End Structured Data ---

---

<Layout 
  title={`${category.name} - EduNews24`}
  description={metaDescription}
  keywords={metaKeywords}
  canonicalUrl={canonicalUrl}
>
  <script type="application/ld+json" set:html={itemListStructuredData} slot="head" />
  <script type="application/ld+json" set:html={breadcrumbStructuredData} slot="head" />

  <main class="bg-gray-50 min-h-screen py-8">
    <div class="container mx-auto px-4">
      <div class="flex flex-col lg:flex-row gap-8">
        <!-- Main Content -->
        <div class="flex-1 border-r border-gray-200 pr-4">
          <div class="flex justify-between items-center mb-4">
            <h1 class="text-3xl font-bold">{category.name}</h1>
            {currentSecondaryFilter && availableSecondaryCategories.find(sc => sc.slug === currentSecondaryFilter) && (
              <span class="text-xl text-gray-600 font-medium ml-2">
                / {availableSecondaryCategories.find(sc => sc.slug === currentSecondaryFilter)?.name}
              </span>
            )}
          </div>

          {/* Original Category Filter for Ultim'Ora page */} 
          {categorySlug === ultimOraSlug && uniqueOriginalCategoriesForFilter.length > 0 && (
            <div class="mb-6 pb-4 border-b border-gray-200">
              <span class="text-sm font-semibold text-gray-700 mr-2">Filtra per Categoria Originale:</span>
              <a 
                href={`/${ultimOraSlug}`}
                class={`px-3 py-1 rounded-full text-xs font-medium mr-2 mb-2 inline-block transition-colors
                  ${!currentOriginalCategoryFilter 
                    ? 'bg-primary text-white' 
                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}
                `}
              >
                Tutte
              </a>
              {uniqueOriginalCategoriesForFilter.map(origCat => (
                <a 
                  href={`/${ultimOraSlug}?original_category_filter=${origCat.slug}`}
                  class={`px-3 py-1 rounded-full text-xs font-medium mr-2 mb-2 inline-block transition-colors
                    ${currentOriginalCategoryFilter === origCat.slug 
                      ? 'bg-primary text-white' 
                      : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}
                  `}
                  title={`Filtra per ${origCat.name}`}
                >
                  {origCat.name}
                </a>
              ))}
            </div>
          )}

          {/* Secondary Category Filters (hide if Ultim'Ora) */} 
          {categorySlug !== ultimOraSlug && availableSecondaryCategories.length > 0 && (
            <div class="mb-6 pb-4 border-b border-gray-200">
              <span class="text-sm font-semibold text-gray-700 mr-2">Filtra per:</span>
              <a 
                href={`/${category.slug}`}
                class={`px-3 py-1 rounded-full text-xs font-medium mr-2 mb-2 inline-block transition-colors
                  ${!currentSecondaryFilter 
                    ? 'bg-primary text-white' 
                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}
                `}
              >
                Tutti
              </a>
              {availableSecondaryCategories.map((sc: SecondaryCategory) => (
                <a 
                  href={`/${category.slug}?secondary_filter=${sc.slug}`}
                  class={`px-3 py-1 rounded-full text-xs font-medium mr-2 mb-2 inline-block transition-colors
                    ${currentSecondaryFilter === sc.slug 
                      ? 'bg-primary text-white' 
                      : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}
                  `}
                  title={`Filtra per ${sc.name}`}
                >
                  {sc.name}
                </a>
              ))}
            </div>
          )}

          {transformedArticles.length === 0 ? (
            <div class="text-center py-12 bg-white rounded-lg shadow-sm">
              <h2 class="text-2xl text-gray-600">Nessun articolo trovato</h2>
              <p class="mt-2 text-gray-500">Torna piÃ¹ tardi per nuovi contenuti</p>
            </div>
          ) : (
            <div class="space-y-8">
              <!-- Featured Article - Mobile -->
              {featuredArticle && (
                <article class={`md:hidden bg-white rounded-lg shadow-sm overflow-hidden border-l-4 ${featuredArticle.borderColor} hover:shadow-md transition-shadow`}>
                  <a href={featuredArticle.href} class="block">
                    <div class="relative">
                      <img 
                        src={featuredArticle.image} 
                        alt={featuredArticle.title}
                        class="w-full h-48 object-cover"
                      />
                    </div>
                    <div class="p-4">
                      <span class={`${featuredArticle.textColor} text-sm font-semibold`}>
                        {featuredArticle.category}
                      </span>
                      <h3 class="font-bold text-gray-900 mt-2 line-clamp-2 hover:text-sport-500 transition-colors">
                        {featuredArticle.title}
                      </h3>
                    </div>
                  </a>
                </article>
              )}

              <!-- Featured Article - Desktop -->
              {featuredArticle && (
                <article class={`hidden md:block bg-white rounded-lg shadow-sm overflow-hidden border-t-4 ${featuredArticle.borderColor} hover:shadow-md transition-shadow`}>
                  <a href={featuredArticle.href} class="block">
                    <div class="relative h-96">
                      <img 
                        src={featuredArticle.image} 
                        alt={featuredArticle.title}
                        class="w-full h-full object-cover"
                      />
                      <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent">
                        <div class="absolute bottom-0 left-0 right-0 p-6">
                          <span class={`inline-block ${featuredArticle.bgColor} text-white px-3 py-1 text-sm font-semibold rounded-sm mb-3`}>
                            {featuredArticle.category}
                          </span>
                          <h2 class="text-3xl font-bold text-white mb-3">
                            {featuredArticle.title}
                          </h2>
                          <p class="text-gray-200 text-lg mb-2">
                            {featuredArticle.excerpt}
                          </p>
                          <time class="text-sm text-white/80">
                            {featuredArticle.date}
                          </time>
                        </div>
                      </div>
                    </div>
                  </a>
                </article>
              )}

              <!-- Secondary Articles -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {secondaryArticles.map(article => (
                  <article class={`bg-white rounded-lg shadow-sm overflow-hidden border-t-4 ${article.borderColor} hover:shadow-md transition-shadow`}>
                    <a href={article.href} class="block">
                      <div class="relative h-64">
                        <img 
                          src={article.image} 
                          alt={article.title}
                          class="w-full h-full object-cover"
                        />
                        <div class="absolute top-3 left-3">
                          <span class={`inline-block ${article.bgColor} text-white px-2 py-1 text-xs font-semibold rounded-sm`}>
                            {article.category}
                          </span>
                        </div>
                      </div>
                      <div class="p-4">
                        <h3 class="text-xl font-bold text-gray-900 mb-2 line-clamp-2">
                          {article.title}
                        </h3>
                        <p class="text-gray-600 text-sm mb-3 line-clamp-3">
                          {article.excerpt}
                        </p>
                        <time class="text-sm text-gray-500">{article.date}</time>
                      </div>
                    </a>
                  </article>
                ))}
              </div>

              <!-- Regular Articles Grid -->
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                {regularArticles.map(article => (
                  <article class={`bg-white rounded-lg shadow-sm overflow-hidden border-t-4 ${article.borderColor} hover:shadow-md transition-shadow`}>
                    <a href={article.href} class="block">
                      <div class="relative h-48">
                        <img 
                          src={article.image} 
                          alt={article.title}
                          class="w-full h-full object-cover"
                        />
                        <div class="absolute top-3 left-3">
                          <span class={`inline-block ${article.bgColor} text-white px-2 py-1 text-xs font-semibold rounded-sm`}>
                            {article.category}
                          </span>
                        </div>
                      </div>
                      <div class="p-4">
                        <h3 class="text-lg font-bold text-gray-900 mb-2 line-clamp-2">
                          {article.title}
                        </h3>
                        <time class="text-sm text-gray-500">{article.date}</time>
                      </div>
                    </a>
                  </article>
                ))}
              </div>
            </div>
          )}
        </div>

        <!-- Sidebar -->
        <div class="lg:w-80 pt-8">
          <CategorySidebar source="category" />
        </div>
      </div>
    </div>
  </main>

  {totalPages > 1 && (
    <nav class="mt-10 mb-8 flex justify-center items-center gap-2 flex-wrap">
      {/* First Page */}
      {page > 1 && (
        <a
          href={`/${category.slug}?page=1${currentSecondaryFilter ? `&secondary_filter=${currentSecondaryFilter}` : ''}${currentOriginalCategoryFilter ? `&original_category_filter=${currentOriginalCategoryFilter}` : ''}`}
          class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 text-sm"
          aria-label="Prima pagina"
        >
          Â«
        </a>
      )}

      {/* Previous */}
      {page > 1 && (
        <a
          href={`/${category.slug}?page=${page - 1}${currentSecondaryFilter ? `&secondary_filter=${currentSecondaryFilter}` : ''}${currentOriginalCategoryFilter ? `&original_category_filter=${currentOriginalCategoryFilter}` : ''}`}
          class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 text-sm"
          aria-label="Pagina precedente"
        >
          â€¹
        </a>
      )}

      {/* Page numbers */}
      {pageItems.map(item => (
        typeof item === 'number' ? (
          <a
            href={`/${category.slug}?page=${item}${currentSecondaryFilter ? `&secondary_filter=${currentSecondaryFilter}` : ''}${currentOriginalCategoryFilter ? `&original_category_filter=${currentOriginalCategoryFilter}` : ''}`}
            class={`px-3 py-1 rounded text-sm
              ${item === page
                ? 'bg-primary text-white pointer-events-none'
                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}
            `}
            aria-current={item === page ? "page" : undefined}
          >
            {item}
          </a>
        ) : (
          <span class="px-3 py-1 text-sm text-gray-500">{DOTS}</span>
        )
      ))}

      {/* Next */}
      {page < totalPages && (
        <a
          href={`/${category.slug}?page=${page + 1}${currentSecondaryFilter ? `&secondary_filter=${currentSecondaryFilter}` : ''}${currentOriginalCategoryFilter ? `&original_category_filter=${currentOriginalCategoryFilter}` : ''}`}
          class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 text-sm"
          aria-label="Pagina successiva"
        >
          â€º
        </a>
      )}

      {/* Last Page */}
      {page < totalPages && (
        <a
          href={`/${category.slug}?page=${totalPages}${currentSecondaryFilter ? `&secondary_filter=${currentSecondaryFilter}` : ''}${currentOriginalCategoryFilter ? `&original_category_filter=${currentOriginalCategoryFilter}` : ''}`}
          class="px-3 py-1 rounded bg-gray-200 hover:bg-gray-300 text-sm"
          aria-label="Ultima pagina"
        >
          Â»
        </a>
      )}
    </nav>
  )}

</Layout> 